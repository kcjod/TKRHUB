<%- include('./partials/header') %>
<div class="w-[90vw] md:w-[80vw] mx-auto">
  <div
    class="w-full flex justify-between items-center relative top-[70px] px-4"
  >
    <div class="text-2xl text-white font-bold">Profile</div>
    <a href="/edit"
      ><button
        class="mt-2 bg-white hover:bg-lime-400 hover:text-white duration-200 text-lime-500 font-bold py-2 px-4 rounded-lg"
      >
        Edit Profile
      </button></a
    >
  </div>
  <div
    class="relative top-[100px] z-5 lg:flex md:flex sm:flex-col xs:flex-col gap-5"
  >
    <div
      class="row1 w-full flex lg:flex md:flex lg:flex-row md:flex-row sm:flex-col md:flex-wrap lg:flex-nowrap items-center lg:gap-5 md:gap-0 sm:gap-2 justify-center"
    >
      <!-- profile img -->
      <div
        class="md:w-[48%] lg:w-[35%] flex w-full bg-blue-100 flex-col items-center rounded-xl gap-2 py-3"
      >
        <div>
          <img
            class="h-[100px] rounded-full my-2"
            src="../images/<%= user.profileimg %>"
            alt=""
          />
        </div>
        <div class="text-lg font-medium">@<%= user.username %></div>
        <div class="stats w-[80%] flex justify-around gap-5">
          <div class="flex flex-col items-center">
            <div class="">Posts</div>
            <div class="text-lg font-medium"><%= user.posts.length %></div>
          </div>
          <div class="flex flex-col items-center">
            <div>Followers</div>
            <div class="text-lg font-medium"><%= user.followers.length %></div>
          </div>
          <div class="flex flex-col items-center">
            <div>Following</div>
            <div class="text-lg font-medium"><%= user.following.length %></div>
          </div>
        </div>
      </div>

      <!-- bio and social container -->
      <div
        class="flex flex-col w-full md:w-[48%] lg:w-[35%] justify-center items-center lg:gap-5 md:gap-5 sm:gap-2 gap-1 lg:ml-0 md:ml-5"
      >
        <!-- bio -->
        <div
          class="flex h-[107px] w-full bg-blue-100 flex-col items-center justify-center rounded-xl gap-1 py-3"
        >
          <div class="text-lg font-medium">Bio</div>
          <% if(user.bio && user.bio.length> 0) { %>
          <div><%= user.bio %></div>
          <% } else { %>
          <div class="text-slate-600 text-sm">Tell about yourself</div>
          <% } %>
        </div>

        <!-- social links -->
        <div
          class="flex h-[107px] w-full bg-blue-100 flex-col items-center justify-center rounded-xl gap-1 py-3"
        >
          <div class="text-lg font-medium">Social links</div>
          <div class="w-[100%] flex justify-around">
            <% if(user.github || user.linkedin || user.instagram) { %> <%
            if(user.github && user.github.length> 0) { %>
            <a href="<%= user.github %>" target="_blank">
              <i class="ri-github-fill text-2xl"></i>
            </a>
            <% } else { %>
            <div class="text-slate-600 text-sm">
              <span class="hidden"><i class="ri-github-fill"></i></span>
            </div>
            <% } %> <% if(user.linkedin && user.linkedin.length> 0) { %>
            <a href="<%= user.linkedin %>" target="_blank">
              <i class="ri-linkedin-box-fill text-2xl"></i>
            </a>
            <% } else { %>
            <div class="text-slate-600 text-sm">
              <span class="hidden"><i class="ri-linkedin-box-fill"></i></span>
            </div>
            <% } %> <% if(user.instagram && user.instagram.length> 0) { %>
            <a href="<%= user.instagram %>" target="_blank">
              <i class="ri-instagram-line text-2xl"></i>
            </a>
            <% } else { %>
            <div class="text-slate-600 text-sm">
              <span class="hidden"><i class="ri-instagram-line"></i></span>
            </div>
            <% } %> <% } else { %>
            <p class="text-sm text-slate-600">No social links added</p>
            <% } %>
          </div>
        </div>
      </div>

      <!-- personal details -->
      <div
        class="lg:flex md:hidden lg:-ml-0 md:-ml-[39%] h-[235px] md:w-[45%] lg:w-[35%] flex w-full bg-blue-100 flex-col items-center justify-center rounded-xl gap-1 py-3"
      >
        <div class="text-lg font-medium">Personal Details</div>
        <div class="clg flex gap-2 items-center">
          <i class="ri-school-line"></i>
          <% if(user.clgname && user.clgname.length> 0) { %>
          <div><%= user.clgname %></div>
          <% } else { %>
          <div class="text-slate-600 text-sm">No college mentioned</div>
          <% } %>
        </div>
        <div class="clg flex gap-2 items-center">
          <i class="ri-graduation-cap-line text-lg"></i>
          <% if(user.clgname && user.clgname.length> 0) { %>
          <div><%= user.branch %></div>
          <% } else { %>
          <div class="text-slate-600 text-sm">No branch specified</div>
          <% } %>
        </div>
        <div class="clg flex gap-2 items-center">
          <i class="ri-mail-open-line"></i>

          <div class="text-slate-600 text-sm"><%= user.email %></div>
        </div>
      </div>
    </div>

    <!-- skill container -->
    <div
      class="w-full flex md:flex-wrap lg:flex-nowrap items-center lg:gap-5 md:gap-5 justify-center"
    >
      <!-- personal details -->
      <div
        class="lg:hidden md:flex hidden h-[235px] md:w-[48%] lg:w-[35%] flex w-full bg-blue-100 flex-col items-center justify-center rounded-xl gap-1 py-3"
      >
        <div class="text-lg font-medium">Personal Details</div>
        <div class="clg flex gap-2 items-center">
          <i class="ri-school-line"></i>
          <% if(user.clgname && user.clgname.length> 0) { %>
          <div><%= user.clgname %></div>
          <% } else { %>
          <div class="text-slate-600 text-sm">No college mentioned</div>
          <% } %>
        </div>
        <div class="clg flex gap-2 items-center">
          <i class="ri-graduation-cap-line text-lg"></i>
          <% if(user.clgname && user.clgname.length> 0) { %>
          <div><%= user.branch %></div>
          <% } else { %>
          <div class="text-slate-600 text-sm">No branch specified</div>
          <% } %>
        </div>
        <div class="clg flex gap-2 items-center">
          <i class="ri-mail-open-line"></i>

          <div class="text-slate-600 text-sm"><%= user.email %></div>
        </div>
      </div>
      <!-- skills -->
      <div
        class="flex skillScroll xl:h-[107px] lg:h-[107px] md:h-[235px] md:w-[48%] lg:w-full w-full bg-blue-100 flex-col items-center justify-center rounded-xl gap-1 py-3 lg:mt-0 md:mt-0 sm:mt-2 mt-1"
      >
        <div class="text-lg font-medium">Skills</div>
        <% if(user.skills && user.skills.length> 0) { %>
        <div><%= user.skills %></div>
        <% } else { %>
        <div class="text-slate-600 text-sm">No skills added</div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Skill Container -->
  <div
    class="w-full flex flex-wrap items-start lg:gap-5 md:gap-5 justify-center"
  >
    <!-- Personal Details -->
    <div
      class="lg:hidden md:flex hidden h-[235px] md:w-[48%] lg:w-[35%] w-full bg-blue-100 flex-col items-center justify-center rounded-xl gap-1 py-3"
    >
      <div class="text-lg font-medium">Personal Details</div>
      <div class="clg flex gap-2 items-center">
        <i class="ri-school-line"></i>
        <% if(user.clgname && user.clgname.length > 0) { %>
        <div><%= user.clgname %></div>
        <% } else { %>
        <div class="text-slate-600 text-sm">No college mentioned</div>
        <% } %>
      </div>
      <div class="clg flex gap-2 items-center">
        <i class="ri-graduation-cap-line text-lg"></i>
        <% if(user.branch && user.branch.length > 0) { %>
        <div><%= user.branch %></div>
        <% } else { %>
        <div class="text-slate-600 text-sm">No branch specified</div>
        <% } %>
      </div>
      <div class="clg flex gap-2 items-center">
        <i class="ri-mail-open-line"></i>
        <div class="text-slate-600 text-sm"><%= user.email %></div>
      </div>
    </div>
  </div>

  <!-- User Posts -->
  <div
    id="feed-container"
    class="w-full flex flex-col justify-start items-center mx-auto mt-28"
  >
    <!-- Increased mt-10 -->
    <% user.posts.forEach(function(post){ %>
    <div
      class="card border-b-4 border-lime-500 w-full text-sm md:text-base rounded-xl bg-zinc-100 shadow-lg flex flex-col p-4 my-4"
    >
      <div class="dets flex gap-3 items-center mb-3">
        <a href="/publicprofile/<%= user.username %>">
          <img
            src="../images/<%= user.profileimg %>"
            alt=""
            class="border h-[40px] rounded-full"
          />
        </a>
        <a href="/publicprofile/<%= user.username %>">
          <div class="font-semibold"><%= user.username %></div>
        </a>
        <div class="text-lime-500"><%= user.followers.length %> followers</div>
        <i
          class="delete fa-regular fa-trash-can fa-lg cursor-pointer ml-auto"
          data-id="<%= post._id %>"
        ></i>
      </div>
      <div class="hero flex flex-col items-start mt-2">
        <div class="content text-start break-words">
          <pre class="whitespace-pre-wrap"><%= post.Truncatedcontent %></pre>
        </div>
        <span class="cursor-pointer text-lime-500 hover:underline"
          >Read More</span
        >
        <div class="btns flex justify-center gap-5 mt-3">
          <div class="cursor-pointer">
            <i class="ri-thumb-up-line"></i>
            <span class="text-zinc-600"><%= post.likes.length %></span>
          </div>
          <div class="cursor-pointer">
            <i class="ri-chat-3-line"></i>
            <span class="text-zinc-600"><%= post.comments.length %></span>
          </div>
          <div class="cursor-pointer">
            <i class="ri-share-line"></i>
          </div>
        </div>
      </div>
    </div>
    <% }) %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const readMoreElements = document.querySelectorAll(".content");

    readMoreElements.forEach((contentElement) => {
      const readMoreSpan = contentElement.querySelector(".text-lime-500");
      const preElement = contentElement.querySelector("pre");

      if (readMoreSpan && preElement) {
        // Original full text
        const fullText = preElement.textContent.trim();

        // Define the truncated text (limit to 150 characters)
        const truncatedText =
          fullText.length > 150 ? fullText.substring(0, 150) + "..." : fullText;

        // Initially set the truncated text
        if (fullText.length > 150) {
          preElement.textContent = truncatedText;
        } else {
          readMoreSpan.style.display = "none"; // Hide "Read More" for short content
        }

        // Add toggle behavior for "Read More" and "Show Less"
        readMoreSpan.addEventListener("click", function () {
          if (preElement.textContent === truncatedText) {
            preElement.textContent = fullText;
            readMoreSpan.textContent = "Show Less";
          } else {
            preElement.textContent = truncatedText;
            readMoreSpan.textContent = "Read More";
          }
        });
      }
    });

    // Handle delete button events here as well
    const deleteButtons = document.querySelectorAll(".delete");
    deleteButtons.forEach((button) => {
      button.addEventListener("click", async (e) => {
        const postId = button.getAttribute("data-id");
        if (confirm("Are you sure you want to delete this post?")) {
          try {
            const response = await fetch(`/post/${postId}`, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            });

            if (response.ok) {
              const postCard = button.closest(".card");
              postCard.remove();
            } else {
              const { error } = await response.json();
              alert(error || "Failed to delete the post");
            }
          } catch (err) {
            alert("An error occurred while deleting the post");
          }
        }
      });
    });
  });
</script>
